FROM python:3.6-slim

# Environment variables needed to build the image
ARG REMOTE="https://github.com/alfaro96/scikit-lr.git"

# Install git to download the project, gcc and
# g++ to compile the files generated by Cython
# and R to execute standard statistical tests
RUN apt-get update
RUN apt-get install -y git gcc g++ make r-base

# Install the Python requirements to build
# the package and some utils to facilite the
# creation and execution of the experiments
COPY requirements/*.txt /req/
RUN pip install --upgrade pip; \
    pip install -r /req/build.txt \
                -r /req/style.txt \
                -r /req/utils.txt

# Install the R requirements to analyze the
# results with the standard statistical tests
COPY commands/* /bin/
RUN chmod +x /bin/pip-r
RUN pip-r /req/analysis.txt

# Get the SHA of the latest commit from the remote git repository to ensure
# that the package is build with the latest version of the master branch
ARG COMMIT="$(git ls-remote $REMOTE | head -1 | sed 's/HEAD//')"

# Build and install the package 
WORKDIR /soft/
RUN git clone $REMOTE .
RUN python setup.py install

# Create a new user to avoid that the
# container is run in privileged mode
ARG USERNAME=scikit-lr
ENV HOME /home/$USERNAME
RUN useradd -ms /bin/bash $USERNAME
USER $USERNAME
RUN mkdir -p $HOME/workspace
WORKDIR $HOME/workspace

CMD python $FILE $ARGUMENTS
